{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% set active = 'dashboard' %}
{% block content %}
<!-- System Stats (Top 3 Cards) -->
<div class="grid grid-cols-3 gap-6 mb-6">
  <!-- CPU -->
  <div class="bg-gray-800 p-4 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-4 flex justify-between items-center">
      <span>CPU</span>
      <span id="cpu-percentage" class="text-xl font-bold text-orange-400">--%</span>
    </h2>

    <div class="w-full bg-gray-700 h-4 rounded-full overflow-hidden">
      <div id="cpu-bar" class="h-4 bg-orange-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
    </div>

    <p class="text-gray-500 text-xs mt-2 text-right">Auto-refreshes every 3s</p>
  </div>

  <!-- RAM -->
  <div class="bg-gray-800 p-4 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-4 flex justify-between items-center">
      <span>RAM</span>
      <span id="memory-percentage" class="text-xl font-bold text-green-400">
        {% if memory_result.percent_used is not none %}
        {{ memory_result.percent_used }}%
        {% else %}
        --%
        {% endif %}
      </span>
    </h2>
    <div class="w-full bg-gray-700 h-4 rounded-full overflow-hidden">
      <div id="memory-bar" class="h-4 bg-green-500 rounded-full transition-all duration-500"
           style="width: {{ memory_result.percent_used if memory_result.percent_used is not none else 0 }}%;"></div>
    </div>
    <div class="flex justify-between text-xs text-gray-400 mt-3">
      <span>Total: <span id="memory-total" class="text-green-300 font-semibold">{{ memory_result.total_memory }}</span></span>
      <span>Used: <span id="memory-used" class="text-green-300 font-semibold">{{ memory_result.used_memory }}</span></span>
      <span>Free: <span id="memory-free" class="text-green-300 font-semibold">{{ memory_result.free_memory }}</span></span>
    </div>
  </div>

  <!-- Storage -->
  <div class="bg-gray-800 p-4 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-4 flex justify-between items-center">
      <span>Storage</span>
      <span id="storage-percentage" class="text-xl font-bold text-blue-400">
        {% if storage_result.percent_used is not none %}
        {{ storage_result.percent_used }}%
        {% else %}
        --%
        {% endif %}
      </span>
    </h2>
    <div class="w-full bg-gray-700 h-4 rounded-full overflow-hidden">
      <div id="storage-bar" class="h-4 bg-blue-500 rounded-full transition-all duration-500"
           style="width: {{ storage_result.percent_used if storage_result.percent_used is not none else 0 }}%;"></div>
    </div>
    <div class="flex justify-between text-xs text-gray-400 mt-3">
      <span>Size: <span id="storage-size" class="text-blue-300 font-semibold">{{ storage_result.size }}</span></span>
      <span>Used: <span id="storage-used" class="text-blue-300 font-semibold">{{ storage_result.used }}</span></span>
      <span>Avail: <span id="storage-available" class="text-blue-300 font-semibold">{{ storage_result.available }}</span></span>
    </div>
  </div>
</div>

<!-- Second Row (Services in Left Card) -->
<div class="grid grid-cols-3 gap-6 mb-6">
    <!-- Running Services -->
    <div class="bg-gray-800 p-4 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">Running Services</h2>
        <ul class="space-y-3">
            {% for service in service_names %}
            <li class="flex items-center text-lg font-semibold text-gray-200">
                <span class="material-icons text-green-400 mr-2">check_circle</span>
                {{ service | upper }}
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="bg-gray-800 p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">Next Card</h2>
        <p class="text-gray-400">Info</p>
    </div>

    <!-- Network Interfaces -->
    <div class="bg-gray-800 p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-4">Network Interfaces</h2>

        <table class="w-full text-left border-collapse text-gray-200 text-base">
            <thead class="border-b border-gray-700 text-gray-400">
                <tr>
                    <th class="py-2">Interface</th>
                    <th class="py-2">Address</th>
                    <th class="py-2">Description</th>
                </tr>
            </thead>
            <tbody>
                {% for name, info in interfaces.items() %}
                <tr class="border-b border-gray-700/50">
                    <td class="py-2 font-semibold">
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-blue-400 text-base">settings_ethernet</span>
                            {{ name }}
                        </div>
                    </td>
                    <td class="py-2">
                        {% if info.address %}
                        {{ info.address[0] }}
                        {% else %}
                        <span class="text-gray-500">N/A</span>
                        {% endif %}
                    </td>
                    <td class="py-2">{{ info.description or "N/A" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
async function updateCPU() {
  try {
    const response = await fetch('/get-cpu-usage');
    const data = await response.json();
    const cpu = data.cpu_total;

    const cpuText = document.getElementById('cpu-percentage');
    const cpuBar = document.getElementById('cpu-bar');

    // Update value
    cpuText.textContent = `${cpu}%`;
    cpuBar.style.width = `${cpu}%`;

    // Dynamic color thresholds
    if (cpu < 50) {
      cpuBar.className = "h-4 bg-green-500 rounded-full transition-all duration-500";
    } else if (cpu < 80) {
      cpuBar.className = "h-4 bg-yellow-500 rounded-full transition-all duration-500";
    } else {
      cpuBar.className = "h-4 bg-red-500 rounded-full transition-all duration-500";
    }

  } catch (err) {
    console.error("Error updating CPU usage:", err);
  }
}

async function updateMemory() {
  try {
    const response = await fetch('/get-memory-usage');
    const data = await response.json();

    const percent = data.percent_used;
    const percentText = document.getElementById('memory-percentage');
    const bar = document.getElementById('memory-bar');

    if (percent !== null && percent !== undefined) {
      const percentValue = Math.max(0, Math.min(percent, 100));
      percentText.textContent = `${percentValue}%`;
      bar.style.width = `${percentValue}%`;
    } else {
      percentText.textContent = '--%';
      bar.style.width = '0%';
    }

    document.getElementById('memory-total').textContent = data.total_memory ?? 'N/A';
    document.getElementById('memory-used').textContent = data.used_memory ?? 'N/A';
    document.getElementById('memory-free').textContent = data.free_memory ?? 'N/A';
  } catch (err) {
    console.error("Error updating memory usage:", err);
  }
}

async function updateStorage() {
  try {
    const response = await fetch('/get-storage-usage');
    const data = await response.json();

    const percent = data.percent_used;
    const percentText = document.getElementById('storage-percentage');
    const bar = document.getElementById('storage-bar');

    if (percent !== null && percent !== undefined) {
      const percentValue = Math.max(0, Math.min(percent, 100));
      percentText.textContent = `${percentValue}%`;
      bar.style.width = `${percentValue}%`;
    } else {
      percentText.textContent = '--%';
      bar.style.width = '0%';
    }

    document.getElementById('storage-size').textContent = data.size ?? 'N/A';
    document.getElementById('storage-used').textContent = data.used ?? 'N/A';
    document.getElementById('storage-available').textContent = data.available ?? 'N/A';
  } catch (err) {
    console.error("Error updating storage usage:", err);
  }
}

// Run immediately and every 3 seconds
updateCPU();
updateMemory();
updateStorage();
setInterval(() => {
  updateCPU();
  updateMemory();
  updateStorage();
}, 3000);
</script>

{% endblock %}
