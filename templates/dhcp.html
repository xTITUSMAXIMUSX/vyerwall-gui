{% extends 'base.html' %}
{% block title %}DHCP{% endblock %}
{% set active = 'services' %}
{% block header %}DHCP Server{% endblock %}
{% block content %}

<div class="bg-gray-800 rounded-xl shadow flex overflow-hidden">
  <!-- Sidebar with interfaces -->
  <div class="w-64 bg-gray-900 border-r border-gray-700">
    <h3 class="text-lg font-semibold p-4 border-b border-gray-700">Interfaces</h3>
    <ul class="divide-y divide-gray-700">
      {% for name, info in interfaces.items() %}
      <li>
        <button 
          class="w-full text-left px-4 py-3 hover:bg-gray-700 flex items-center justify-between select-interface"
          data-iface="{{ name }}"
          data-description="{{ info.description or name }}">
          <div class="flex items-center gap-2">
            <span class="material-icons text-blue-400 text-sm">settings_ethernet</span>
            {{ name }}
          </div>
          <span class="material-icons text-sm text-gray-400">chevron_right</span>
        </button>
      </li>
      {% endfor %}
    </ul>
  </div>

<div class="flex-1 p-6 max-w-3xl">
  <h2 class="text-xl font-bold mb-4" id="ifaceTitle">DHCP Server Configuration</h2>

  <form id="dhcpForm" class="space-y-4 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
    <div class="flex items-center gap-2">
      <input type="checkbox" id="enableDhcp" name="enabled"
        class="h-4 w-4 text-blue-500 bg-gray-700 border border-gray-600 rounded">
      <label for="enableDhcp" class="text-sm text-gray-300 select-none">Enable DHCP Server</label>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Shared Network Name</label>
        <input type="text" id="sharedNetwork" name="sharedNetwork" placeholder="LAN"
          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"
          required>
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">Subnet</label>
        <input type="text" id="subnet" name="subnet" placeholder="192.168.1.0/24" readonly
          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"
          required>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Default Router</label>
        <input type="text" id="defaultRouter" name="defaultRouter" placeholder="192.168.1.1"
          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"
          required>
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">Name Server</label>
        <input type="text" id="nameServer" name="nameServer" placeholder="192.168.1.1"
          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"
          required>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Domain Name</label>
        <input type="text" id="domainName" name="domainName" placeholder="vyos.net"
          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"
          required>
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">Lease Time (seconds)</label>
        <input type="number" id="lease" name="lease" placeholder="86400" min="1" step="1" value="86400"
          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"
          required>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Start Address</label>
        <input type="text" id="startAddress" name="startAddress" placeholder="192.168.1.2"
          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"
          required>
      </div>

      <div>
        <label class="block text-sm text-gray-300 mb-1">End Address</label>
        <input type="text" id="endAddress" name="endAddress" placeholder="192.168.1.254"
          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none"
          required>
      </div>
    </div>

    <div>
      <label class="block text-sm text-gray-300 mb-1">Subnet ID</label>
      <input type="text" id="subnetId" name="subnetId" value="{{ next_subnet_id }}" readonly
        class="w-24 p-2 rounded bg-gray-700 text-gray-400 border border-gray-600 cursor-not-allowed"
        required>
    </div>

    <div class="pt-4">
      <button type="submit"
        class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg shadow text-white font-medium transition-colors">
        Save DHCP Configuration
      </button>
    </div>
  </form>
</div>


<script>
const form = document.getElementById('dhcpForm');
const fields = {
  sharedNetwork: document.getElementById('sharedNetwork'),
  subnet: document.getElementById('subnet'),
  defaultRouter: document.getElementById('defaultRouter'),
  nameServer: document.getElementById('nameServer'),
  domainName: document.getElementById('domainName'),
  lease: document.getElementById('lease'),
  startAddress: document.getElementById('startAddress'),
  endAddress: document.getElementById('endAddress'),
  subnetId: document.getElementById('subnetId')
};
const enableCheckbox = document.getElementById('enableDhcp');
fields.subnetId.dataset.defaultValue = fields.subnetId.value;

let selectedInterface = null;
let originalState = null;
let interfaceDefaults = null;

function normalizeNameServer(value) {
  if (!value) {
    return '';
  }
  return value
    .split(',')
    .map(part => part.trim())
    .filter(Boolean)
    .join(', ');
}

function buildStateFromResponse(data, defaults) {
  return {
    sharedNetwork: (data.shared_network_name || defaults.sharedNetwork || '').trim(),
    subnet: (data.subnet || '').trim(),
    defaultRouter: (data.default_router || data.interface_ip || defaults.defaultRouter || '').trim(),
    nameServer: normalizeNameServer(data.name_server || ''),
    domainName: (data.domain_name || 'vyos.net').trim(),
    lease: String(data.lease || 86400).trim(),
    startAddress: (data.start || '').trim(),
    endAddress: (data.end || '').trim(),
    subnetId: data.subnet_id ? String(data.subnet_id).trim() : '',
    enabled: Boolean(data.enabled),
    isConfigured: Boolean(data.is_configured),
    nextAvailableSubnetId: data.next_available_subnet_id ? String(data.next_available_subnet_id).trim() : ''
  };
}

function applyStateToForm(state) {
  if (state.nextAvailableSubnetId) {
    fields.subnetId.dataset.defaultValue = state.nextAvailableSubnetId;
  }
  fields.sharedNetwork.value = state.sharedNetwork;
  fields.subnet.value = state.subnet;
  fields.defaultRouter.value = state.defaultRouter;
  fields.nameServer.value = normalizeNameServer(state.nameServer);
  fields.domainName.value = state.domainName;
  fields.lease.value = state.lease || '86400';
  fields.startAddress.value = state.startAddress;
  fields.endAddress.value = state.endAddress;
  const defaultSubnetId = fields.subnetId.dataset.defaultValue || '';
  fields.subnetId.value = state.subnetId || defaultSubnetId;
  enableCheckbox.checked = Boolean(state.enabled);
}

function getFormValues() {
  return {
    sharedNetwork: fields.sharedNetwork.value.trim(),
    subnet: fields.subnet.value.trim(),
    defaultRouter: fields.defaultRouter.value.trim(),
    nameServer: normalizeNameServer(fields.nameServer.value),
    domainName: fields.domainName.value.trim(),
    lease: fields.lease.value.trim(),
    startAddress: fields.startAddress.value.trim(),
    endAddress: fields.endAddress.value.trim(),
    subnetId: fields.subnetId.value.trim(),
    enabled: enableCheckbox.checked
  };
}

async function fetchInterfaceDhcp(iface, description) {
  document.getElementById('ifaceTitle').textContent = `DHCP Settings for ${iface}`;
  const response = await fetch(`/services/dhcp/${iface}`);
  if (!response.ok) {
    throw new Error('Unable to load DHCP configuration.');
  }
  const data = await response.json();
  interfaceDefaults = {
    sharedNetwork: description || iface,
    defaultRouter: data.interface_ip || ''
  };
  const state = buildStateFromResponse(data, interfaceDefaults);
  applyStateToForm(state);
  originalState = {
    sharedNetwork: state.sharedNetwork,
    subnet: state.subnet,
    defaultRouter: state.defaultRouter,
    nameServer: state.nameServer,
    domainName: state.domainName,
    lease: state.lease,
    startAddress: state.startAddress,
    endAddress: state.endAddress,
    subnetId: state.subnetId,
    enabled: state.enabled,
    isConfigured: state.isConfigured
  };
  selectedInterface = iface;
  document.getElementById('dhcpForm').classList.remove('hidden');
}

document.querySelectorAll('.select-interface').forEach(btn => {
  btn.addEventListener('click', async () => {
    try {
      await fetchInterfaceDhcp(btn.dataset.iface, btn.dataset.description);
    } catch (error) {
      console.error(error);
      alert(error.message || 'Failed to load DHCP configuration.');
    }
  });
});

function ipToBigInt(ip) {
  const parts = ip.split('.').map(part => Number(part));
  if (parts.length !== 4 || parts.some(part => Number.isNaN(part) || part < 0 || part > 255)) {
    return null;
  }
  return parts.reduce((total, part) => (total << 8n) + BigInt(part), 0n);
}

function parseCidr(cidr) {
  const [address, prefixStr] = cidr.split('/');
  const prefix = Number(prefixStr);
  if (!address || Number.isNaN(prefix) || prefix < 0 || prefix > 32) {
    return null;
  }
  const network = ipToBigInt(address);
  if (network === null) {
    return null;
  }
  const hostBits = 32 - prefix;
  const mask = prefix === 0 ? 0n : (~((1n << BigInt(hostBits)) - 1n) & 0xffffffffn);
  const start = network & mask;
  const end = start | (~mask & 0xffffffffn);
  return { start, end };
}

function validateAddressRange() {
  const subnetValue = fields.subnet.value.trim();
  const startValue = fields.startAddress.value.trim();
  const endValue = fields.endAddress.value.trim();

  const range = parseCidr(subnetValue);
  if (!range) {
    alert('Subnet must be a valid IPv4 network in CIDR notation.');
    return false;
  }

  const startIp = ipToBigInt(startValue);
  if (startIp === null) {
    alert('Start address must be a valid IPv4 address.');
    return false;
  }

  const endIp = ipToBigInt(endValue);
  if (endIp === null) {
    alert('End address must be a valid IPv4 address.');
    return false;
  }

  if (startIp < range.start || startIp > range.end) {
    alert('Start address must be within the selected subnet.');
    return false;
  }

  if (endIp < range.start || endIp > range.end) {
    alert('End address must be within the selected subnet.');
    return false;
  }

  if (endIp < startIp) {
    alert('End address must be greater than or equal to the start address.');
    return false;
  }

  return true;
}

form.addEventListener('submit', async (event) => {
  event.preventDefault();

  if (typeof form.checkValidity === 'function' && !form.checkValidity()) {
    if (typeof form.reportValidity === 'function') {
      form.reportValidity();
    }
    return;
  }

  if (!validateAddressRange()) {
    return;
  }

  if (!selectedInterface) {
    alert('Please choose an interface first.');
    return;
  }

  const currentValues = getFormValues();
  const isConfigured = Boolean(originalState?.isConfigured);
  const endpoint = isConfigured
    ? `/services/dhcp/${selectedInterface}/update`
    : `/services/dhcp/${selectedInterface}/create`;

  const payload = isConfigured
    ? { data: currentValues, original: originalState }
    : { data: currentValues };

  try {
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (!response.ok || result.status !== 'ok') {
      throw new Error(result.message || 'Failed to save DHCP configuration.');
    }

    const updatedData = result.data || {};
    const defaults = {
      sharedNetwork: interfaceDefaults?.sharedNetwork || currentValues.sharedNetwork,
      defaultRouter: updatedData.interface_ip || interfaceDefaults?.defaultRouter || currentValues.defaultRouter
    };
    const updatedState = buildStateFromResponse(updatedData, defaults);
    applyStateToForm(updatedState);
    originalState = {
      sharedNetwork: updatedState.sharedNetwork,
      subnet: updatedState.subnet,
      defaultRouter: updatedState.defaultRouter,
      nameServer: updatedState.nameServer,
      domainName: updatedState.domainName,
      lease: updatedState.lease,
      startAddress: updatedState.startAddress,
      endAddress: updatedState.endAddress,
      subnetId: updatedState.subnetId,
      enabled: updatedState.enabled,
      isConfigured: updatedState.isConfigured
    };

    interfaceDefaults = interfaceDefaults || {};
    interfaceDefaults.sharedNetwork = updatedState.sharedNetwork || interfaceDefaults.sharedNetwork;
    interfaceDefaults.defaultRouter = updatedState.defaultRouter || interfaceDefaults.defaultRouter;

    alert('DHCP configuration saved.');
  } catch (error) {
    console.error(error);
    alert(error.message || 'Failed to save DHCP configuration.');
  }
});
</script>


{% endblock %}
