{% macro format_group_display(value, firewall_groups_details) -%}
  {%- if value and value.startswith('[group:') -%}
    {%- set parts = value[7:-1].split(':') -%}
    {%- if parts|length >= 2 -%}
      {%- set group_type = parts[0] -%}
      {%- set group_name = parts[1:] | join(':') -%}
      {%- set lookup_key = group_type ~ ':' ~ group_name -%}
      {%- set members = firewall_groups_details.get(lookup_key, []) -%}
      {%- set member_list = members[:5] | join(', ') -%}
      {%- set more_count = members|length - 5 -%}
      <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-500/20 border border-purple-500/40 rounded-md text-purple-300 text-xs font-medium cursor-help group-badge"
            data-group-type="{{ group_type }}"
            data-group-name="{{ group_name }}"
            data-tooltip="{{ member_list }}{% if more_count > 0 %} +{{ more_count }} more{% endif %}">
        <span class="material-icons" style="font-size: 14px;">workspaces</span>
        <span>{{ group_name }}</span>
      </span>
    {%- else -%}
      {{ value }}
    {%- endif -%}
  {%- else -%}
    {{ value if value else 'Any' }}
  {%- endif -%}
{%- endmacro %}

{% macro rule_row(rule, action_meta, firewall_groups_details) -%}
  {%- set proto_norm = (rule.protocol or '')|lower -%}
  {%- set protocol_display = 'All' if proto_norm in ['all', 'any', ''] else (rule.protocol or 'Any') -%}
  {%- set source_display = rule.source if rule.source and rule.source|lower != 'any' else 'Any' -%}
  {%- set source_port_display = rule.source_port if rule.source_port is not none and rule.source_port|string|trim != '' and rule.source_port|string|lower != 'any' else 'Any' -%}
  {%- set dest_display = rule.destination if rule.destination and rule.destination|lower != 'any' else 'Any' -%}
  {%- set dest_port_display = rule.destination_port if rule.destination_port is not none and rule.destination_port|string|trim != '' and rule.destination_port|string|lower != 'any' else 'Any' -%}
  {%- set action_info = action_meta.get((rule.action or '')|lower, action_meta['default']) -%}
  <tr class="border-t border-gray-800 transition-colors{% if rule.disabled %} bg-yellow-500/10 disabled-firewall-rule{% endif %}"
      data-disabled="{{ 'true' if rule.disabled else 'false' }}">
    <td class="px-4 py-3 font-mono text-gray-100">
      <div class="flex items-center gap-2">
        <span class="material-icons text-gray-500 text-base drag-handle">drag_indicator</span>
        <span class="material-icons text-base {{ action_info.class }}" title="{{ action_info.label }}">{{ action_info.icon }}</span>
        <span class="sr-only">{{ action_info.label }}</span>
        {{ rule.number }}
      </div>
    </td>
    <td class="px-4 py-3">{{ protocol_display }}</td>
    <td class="px-4 py-3">{{ format_group_display(source_display, firewall_groups_details) }}</td>
    <td class="px-4 py-3">{{ format_group_display(source_port_display, firewall_groups_details) }}</td>
    <td class="px-4 py-3">{{ format_group_display(dest_display, firewall_groups_details) }}</td>
    <td class="px-4 py-3">{{ format_group_display(dest_port_display, firewall_groups_details) }}</td>
    <td class="px-4 py-3">{{ rule.description or '-' }}</td>
    <td class="px-4 py-3">
      <div class="flex items-center gap-2 text-sm">
        <button class="text-blue-400 hover:text-blue-300 btn-rule-edit flex items-center gap-1"
                data-rule-number="{{ rule.number }}">
          <span class="material-icons text-base">edit</span>
          <span class="sr-only">Edit</span>
        </button>
        <button class="text-red-400 hover:text-red-300 btn-rule-delete flex items-center gap-1"
                data-rule-number="{{ rule.number }}">
          <span class="material-icons text-base">delete</span>
          <span class="sr-only">Delete</span>
        </button>
        <button class="btn-rule-disable flex items-center gap-1 {{ 'text-green-400 hover:text-green-300' if rule.disabled else 'text-yellow-400 hover:text-yellow-300' }}"
                data-rule-number="{{ rule.number }}">
          <span class="material-icons text-base">{{ rule.disabled and 'check_circle' or 'block' }}</span>
          <span class="sr-only">{{ rule.disabled and 'Enable' or 'Disable' }}</span>
        </button>
      </div>
    </td>
  </tr>
{%- endmacro %}
